UserEnv tasks

1. Fix deploy_app_bundle 
   - review and find what needs to run under container vs. outside.

Deploy: manage.py commands
File "/home/shimon/dev/noderabbit/tasks/dz/tasklib/tests/unittests/test_deploy.py", line 207, in test_managepy_cmd
  - need to invoke this_bundle via env

Deploy: create & upload local bundle
  File "/home/shimon/dev/noderabbit/tasks/dz/tasklib/tests/unittests/test_deploy.py", line 65, in create_test_bundle_in_local_storage
  - need to do upload as dztasks



======================================================================
ERROR: Test taking down a deployed bundle.
----------------------------------------------------------------------
- also OK in isolation.

======================================================================
ERROR: Test that serving a bundle downloads it (so static media are on
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/shimon/dev/noderabbit/lib/python2.6/site-packages/mocker.py", line 147, in test_method_wrapper
    result = test_method()
  File "/home/shimon/dev/noderabbit/tasks/dz/tasklib/tests/unittests/test_nginx.py", line 98, in test_downloads_bundle_when_new
    bundle_tgz_name = create_test_bundle_in_local_storage()
  File "/home/shimon/dev/noderabbit/tasks/dz/tasklib/tests/unittests/test_deploy.py", line 52, in create_test_bundle_in_local_storage
    force_bundle_name=bundle_name)
  File "/home/shimon/dev/noderabbit/tasks/dz/tasklib/bundle.py", line 163, in bundle_app
    utils.install_requirements(reqs, bundle_dir, env=ue)
  File "/home/shimon/dev/noderabbit/tasks/dz/tasklib/utils.py", line 162, in install_requirements
    output, stderr, p = env.subproc(pipcmd)
  File "/home/shimon/dev/noderabbit/tasks/dz/tasklib/userenv.py", line 124, in subproc
    return_details=True)
TypeError: 'NoneType' object is not iterable
-------------------- >> begin captured stdout << ---------------------
Making a bundle fixture for testing.
[localhost] run: virtualenv  --python=/usr/bin/python /tmp/tmpXNlsu6/test_deploy_app/bundle_test_deploy_app_2011-fixture
=== output from pip ===
Unpacking /cust/django/Django-1.2.5.tar.gz
  Running setup.py egg_info for package from file:///cust/django/Django-1.2.5.tar.gz
Installing collected packages: Django
  Running setup.py install for Django
    changing mode of build/scripts-2.6/django-admin.py from 644 to 755
    changing mode of /tmp/tmpXNlsu6/test_deploy_app/bundle_test_deploy_app_2011-fixture/bin/django-admin.py to 755
Successfully installed Django
Cleaning up...

=== end of output from pip ===
Running mock utils.local_privileged(['project_chown', 'test_deploy_app', '/tmp/tmpXNlsu6/test_deploy_app/bundle_test_deploy_app_2011-fixture'])...
Running mock utils.local_privileged(['project_chown', 'test_deploy_app', '/tmp/ctr-test_deploy_app-ToG1HC'])...
Running mock utils.local_privileged(['mount_bind_readonly', '/usr', '/tmp/ctr-test_deploy_app-ToG1HC/usr'])...
Running mock utils.local_privileged(['mount_bind_readonly', '/bin', '/tmp/ctr-test_deploy_app-ToG1HC/bin'])...
Running mock utils.local_privileged(['mount_bind_readonly', '/lib', '/tmp/ctr-test_deploy_app-ToG1HC/lib'])...
Running mock utils.local_privileged(['mount_bind_readonly', '/lib64', '/tmp/ctr-test_deploy_app-ToG1HC/lib64'])...
Running mock utils.local_privileged(['mount_bind_readonly', '/etc', '/tmp/ctr-test_deploy_app-ToG1HC/etc'])...
Running mock utils.local_privileged(['mount_bind_readwrite', '/tmp/tmpXNlsu6/test_deploy_app', '/tmp/ctr-test_deploy_app-ToG1HC/tmp/tmpXNlsu6/test_deploy_app'])...
Running mock utils.local_privileged(['move_into_container', 'test_deploy_app', '/tmp/ctr-test_deploy_app-ToG1HC', '/tmp/ctr-write-test_deploy_app-2eJmiV', '/tmp/tmpXNlsu6/test_deploy_app/bundle_test_deploy_app_2011-fixture/noderabbit_requirements.txt'])...
Running mock utils.local_privileged(['run_in_container', 'test_deploy_app', '/tmp/ctr-test_deploy_app-ToG1HC', '/tmp/tmpXNlsu6/test_deploy_app/bundle_test_deploy_app_2011-fixture/bin/pip', 'install', '--log=/tmp/tmpXNlsu6/test_deploy_app/bundle_test_deploy_app_2011-fixture/dz-pip.log', '-r', '/tmp/tmpXNlsu6/test_deploy_app/bundle_test_deploy_app_2011-fixture/noderabbit_requirements.txt'])...

--------------------- >> end captured stdout << ----------------------




FAIL: Test actually serving a deployed bundle, then taking it down.
-- not actually a problem.

Ran 77 tests in 69.294s

FAILED (errors=2, failures=1)
(noderabbit)shimon@adaptivelk:~/dev/noderabbit/tasks/dz/tasklib/tests$ 
